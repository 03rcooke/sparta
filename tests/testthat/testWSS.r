context("Test WSS")

# Create data
n <- 150 #size of dataset
nyr <- 20 # number of years in data
nSamples <- 20 # set number of dates
set.seed(seed = 125)

# Create somes dates
first <- as.POSIXct(strptime("2003/01/01", "%Y/%m/%d")) 
last <- as.POSIXct(strptime(paste(2003+(nyr-1),"/12/31", sep=''), "%Y/%m/%d")) 
dt <- last-first 
rDates <- first + (runif(nSamples)*dt)

# taxa are set as random letters
taxa <- sample(letters, size = n, TRUE)

# three sites are visited randomly
site <- sample(c('one', 'two', 'three'), size = n, TRUE)

# the date of visit is selected at random from those created earlier
time_period <- sample(rDates, size = n, TRUE)

# combine this to a dataframe
df <- unique(data.frame(taxa, site, time_period))

test_that("Test WSS2", {
 
  set.seed(seed = 125)
  results <- WSS(df$taxa,
                  df$site,
                  df$time_period,
                  minL = 4,
                  minTP = 3) 
  
  expected <- structure(list(species_name = structure(1:24, .Label = c("j", 
                                                                       "s", "r", "h", "p", "b", "t", "d", "e", "a", "y", "m", "x", "c", 
                                                                       "w", "o", "n", "q", "v", "k", "z", "f", "g", "i"), class = "factor"), 
                             intercept.estimate = c(-1.57619083577126, -13.8495754516103, 
                                                    -1.18280256698858, -2.64878621157404, -1.28374976649498, 
                                                    -2.12537149340661, -1.17761952653023, -1.51400669031581, 
                                                    -2.17694670870581, -1.17813615841209, -0.769632624327203, 
                                                    -2.81871216623466, -1.1987476808411, -1.69964633229247, -1.84414443605511, 
                                                    -1.77291892148902, -2.13626675520563, -1.71689286382205, 
                                                    -299.847650643158, -1.91006662549916, -2.475926206912, -1.33051949786452, 
                                                    -2.81871216623466, -2.83618515608237), year.estimate = c(-0.137664655677721, 
                                                                                                             -0.255972184926112, 0.0243500035155962, -0.566460540397709, 
                                                                                                             -0.0468771833560082, 0.0112167453431509, 0.0643782172801676, 
                                                                                                             -0.122016362636812, -0.148006283952421, 0.0342324501489189, 
                                                                                                             0.0722547833992333, 0.174123271705114, 0.0962145486567872, 
                                                                                                             0.0720377568709633, -0.195852342347312, 0.11711347726114, 
                                                                                                             -0.25123726518694, 0.0864040814080048, 37.4809563304292, 
                                                                                                             -0.0856616201509247, 0.052983985418381, 0.171895782899429, 
                                                                                                             0.174123271705114, -0.11415650840461), intercept.stderror = c(0.87271447234245, 
                                                                                                                                                                           12.5543883737514, 0.662379880798868, 3.21124050127362, 0.703719558001864, 
                                                                                                                                                                           1.65662441796632, 0.669932758331245, 0.833673014957086, 1.11965730014412, 
                                                                                                                                                                           0.66229118393043, 0.615764407978849, 1.431954215685, 0.690550563786608, 
                                                                                                                                                                           0.789369553469948, 1.07213154210878, 0.848359111054414, 1.26525679516755, 
                                                                                                                                                                           0.803704485290518, 3747.46445785326, 0.914854669875221, 1.05340271760867, 
                                                                                                                                                                           0.790145647086538, 1.431954215685, 1.41652735197116), year.stderror = c(0.127899223807658, 
                                                                                                                                                                                                                                                   1.28363767963825, 0.0993400015871386, 0.569115067435634, 
                                                                                                                                                                                                                                                   0.104353234986022, 0.132566423233896, 0.101284703627579, 
                                                                                                                                                                                                                                                   0.122441152913946, 0.15823955193126, 0.0995150124615277, 
                                                                                                                                                                                                                                                   0.0935870947012417, 0.203949491797337, 0.105109786611253, 
                                                                                                                                                                                                                                                   0.118845056593527, 0.153102029779358, 0.12734934476106, 0.182041656739027, 
                                                                                                                                                                                                                                                   0.120974440363535, 468.433078990239, 0.132954541387084, 0.157909924089591, 
                                                                                                                                                                                                                                                   0.121915716838618, 0.203949491797337, 0.198270242835728), 
                             intercept.zvalue = c(-1.80607848926879, -1.10316608338857, 
                                                  -1.78568613159273, -0.82484828231442, -1.82423488433382, 
                                                  -1.2829531367259, -1.75781750016762, -1.81606776656163, -1.94429733850312, 
                                                  -1.77887942191882, -1.24988163387586, -1.96843735320566, 
                                                  -1.73593034848572, -2.15316935498853, -1.72007292354056, 
                                                  -2.08982127779059, -1.6884056765115, -2.13622406648812, -0.0800134741811336, 
                                                  -2.08783612129309, -2.35040803058929, -1.6838914480773, -1.96843735320566, 
                                                  -2.00220994824823), year.zvalue = c(-1.07635254991656, -0.199411554355625, 
                                                                                      0.245117808803707, -0.995335693623635, -0.449216388569914, 
                                                                                      0.0846122650783183, 0.635616386032825, -0.996530657650433, 
                                                                                      -0.935330529858395, 0.343992823817945, 0.772059263404772, 
                                                                                      0.853756830530071, 0.915371934039169, 0.606148534367281, 
                                                                                      -1.27922760155148, 0.919623712873239, -1.38010865033552, 
                                                                                      0.714234189869824, 0.0800134704646044, -0.644292547341645, 
                                                                                      0.335532967442377, 1.40995588884549, 0.853756830530071, -0.575762185852526
                                                  ), intercept.pvalue = c(0.070906080305768, 0.269955047232846, 
                                                                          0.0741500921017838, 0.409457731238072, 0.0681165698628925, 
                                                                          0.199508494901557, 0.0787785666955547, 0.0693599775144547, 
                                                                          0.0518596054264458, 0.07525953250101, 0.211342789461164, 
                                                                          0.0490177375929778, 0.0825761508869597, 0.0313053711560582, 
                                                                          0.0854191868133481, 0.0366338572367188, 0.0913333815550908, 
                                                                          0.0326611547082257, 0.936226539484411, 0.0368126199963619, 
                                                                          0.0187528413234339, 0.0922026493889603, 0.0490177375929778, 
                                                                          0.0452621561999708), year.pvalue = c(0.281769614946285, 0.841940822917499, 
                                                                                                               0.806365214045797, 0.319573023285896, 0.653275566248193, 
                                                                                                               0.932569647915748, 0.525026486651066, 0.318992378861951, 
                                                                                                               0.349617986309252, 0.730851682908968, 0.440079328037691, 
                                                                                                               0.393239738289503, 0.359996407127171, 0.544416124543929, 
                                                                                                               0.200816918776191, 0.357769430607515, 0.167553194271885, 
                                                                                                               0.47508237862208, 0.936226542440295, 0.51938574744968, 0.737223080155663, 
                                                                                                               0.158552708321573, 0.393239738289503, 0.564775936133011), 
                             observations = c(3, 3, 3, 5, 3, 2, 3, 3, 2, 3, 4, 1, 3, 2, 
                                              3, 2, 3, 2, 2, 2, 1, 3, 1, 1)), .Names = c("species_name", 
                                                                                         "intercept.estimate", "year.estimate", "intercept.stderror", 
                                                                                         "year.stderror", "intercept.zvalue", "year.zvalue", "intercept.pvalue", 
                                                                                         "year.pvalue", "observations"), class = "data.frame", row.names = c(NA, 
                                                                                                                                                             24L), intercept_year = 2013, min_year = -10, max_year = 9, nVisits = 13L, model_formula = "cbind(successes, failures) ~ year + (1|site)", minL = 4, minTP = 3)
  
  expect_equal(object = results, expected = expected)
  
})